<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Stack PRFs by Common Conversion points (CCP) method - Seispy Documentation</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="icon" href="https://xumi1993.github.io/seispy/favicon.png">

  
  
  <link rel="stylesheet" href="/seispy/css/style.min.020d604e977275cf093999068602ba80e6eb2f78df409ccca5a76f02778bea56.css">
  

  

</head>

<body class='page page-default-single'>
  <div id="main-menu-mobile" class="main-menu-mobile">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="/seispy/">
        <span>Home</span>
      </a>
    </li>
    
    <li class="menu-item-source code">
      <a href="https://github.com/xumi1993/seispy">
        <span>Source Code</span>
      </a>
    </li>
    
    <li class="menu-item-docs">
      <a href="/seispy/docs/">
        <span>Docs</span>
      </a>
    </li>
    
  </ul>
</div>
  <div class="wrapper">
    <div class='header'>
  <div class="container">
    <div class="logo">
      <a href="https://xumi1993.github.io/seispy"><img alt="Logo" src="/seispy/images/seispy.png" /></a>
    </div>
    <div class="logo-mobile">
      <a href="https://xumi1993.github.io/seispy"><img alt="Logo" src="/seispy/images/seispy.png" /></a>
    </div>
    <div id="main-menu" class="main-menu">
  <ul>
    
    
    <li class="menu-item-home">
      <a href="/seispy/">
        <span>Home</span>
      </a>
    </li>
    
    <li class="menu-item-source code">
      <a href="https://github.com/xumi1993/seispy">
        <span>Source Code</span>
      </a>
    </li>
    
    <li class="menu-item-docs">
      <a href="/seispy/docs/">
        <span>Docs</span>
      </a>
    </li>
    
  </ul>
</div>
    <button id="toggle-main-menu-mobile" class="hamburger hamburger--slider" type="button">
  <span class="hamburger-box">
    <span class="hamburger-inner"></span>
  </span>
</button>
  </div>
</div>


    
    
    
    
    
    

    
    <div class="container pt-2 pt-md-6 pb-3 pb-md-6">
      <div class="row">
        <div class="col-12 col-md-3 mb-3">
          <div class="sidebar">
            
<div class="docs-menu">
  <h4>Docs</h4>
  <ul>
    
    <li class="">
      <a href="https://xumi1993.github.io/seispy/docs/install-seispy/">Install Seispy</a>
    </li>
    
    <li class="">
      <a href="https://xumi1993.github.io/seispy/docs/rf-single/">Calculate a P-wave Receiver Function (PRF)</a>
    </li>
    
    <li class="active ">
      <a href="https://xumi1993.github.io/seispy/docs/ccp/">Stack PRFs by Common Conversion points (CCP) method</a>
    </li>
    
  </ul>
</div>

          </div>
        </div>
        <div class="col-12 col-md-9">
          
<h1 class="title">Stack PRFs by Common Conversion points (CCP) method</h1>
<div class="content">
  

<p>This note will introduce how to stack PRFs by CCP method in two steps.</p>

<p><strong>1. Convert PRFs from time axis to depth axis according to 1D velocity model.<br />
1. Search and stack amplitudes in each bin with calculated pierce points falling in.</strong></p>

<h3 id="preparation">Preparation</h3>

<p>Befor the CCP stacking, we should prepare:</p>

<h4 id="1-prfs-data-with-sac-format">1. PRFs data with sac format</h4>

<ul>
<li>the SACHeader of <code>b</code>, <code>delta</code> and <code>npts</code> are required. please make sure that they are correct. The <code>b</code> denote the shift time before P arrival.</li>
<li>All of SAC files belong to a same station must be put into a same <strong>directory with name of the station name</strong>.</li>
<li>A list file with 10 columns is required in this directory, whose format as:

<ul>
<li><code>evt</code>: the datetime part of sacfile name of each PRF.</li>
<li><code>phase</code>: The phase part of sacfile name of each PRF.</li>
<li><code>evlat</code>: The latitude of the event.</li>
<li><code>evlon</code>: The longitude of the event.</li>
<li><code>evdep</code>: The focal depth of the event.</li>
<li><code>dis</code>: The epicentral distance between event and station.</li>
<li><code>bazi</code>: The back-azimuth from event to station.</li>
<li><code>rayp</code>: The ray parameter of the event.</li>
<li><code>mag</code>: The magnitude of the event.</li>
<li><code>f0</code>: The gauss factor used in computing the PRF.</li>
</ul></li>
</ul>

<h4 id="2-a-station-list">2. A station list</h4>

<p>A text table of station information with 3 columns:</p>

<ul>
<li><code>station</code>: The station name which should be the same as the directory name including PRF Files.</li>
<li><code>stlat</code>: The latitude of the station.</li>
<li><code>stlon</code>: The longitude of the station.</li>
</ul>

<h4 id="3-a-parameter-file">3. A parameter file</h4>

<p>The parameter file include parameters used in CCP stacking. the format should follow <code>configparser</code> as the following example:</p>
<div class="highlight"><pre class="chroma"><code class="language-Python" data-lang="Python"><span class="p">[</span><span class="n">FileIO</span><span class="p">]</span>
<span class="c1"># Path to stations with RF sac files</span>
<span class="n">rfpath</span> <span class="o">=</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">RFresult</span>

<span class="c1"># Path to station list</span>
<span class="n">stalist</span> <span class="o">=</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="n">to</span><span class="o">/</span><span class="n">sta_all</span><span class="o">.</span><span class="n">lst</span>

<span class="c1"># Path to the lib of Ps ray parameters. </span>
<span class="c1"># If it&#39;s empty the ray parameters of Ps would be assumed as that of P arrival</span>
<span class="n">rayp_lib</span> <span class="o">=</span>

<span class="c1"># Output data struct after time to depth</span>
<span class="n">depthdat</span> <span class="o">=</span>  <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">xumj</span><span class="o">/</span><span class="n">Researches</span><span class="o">/</span><span class="n">NETibet</span><span class="o">/</span><span class="n">ccp_result</span><span class="o">/</span><span class="n">RFdepth_3D</span><span class="o">.</span><span class="n">mat</span>

<span class="c1"># Output data struct after CCP stacking</span>
<span class="n">stackfile</span> <span class="o">=</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">xumj</span><span class="o">/</span><span class="n">Researches</span><span class="o">/</span><span class="n">NETibet</span><span class="o">/</span><span class="n">Ordos_Process</span><span class="o">/</span><span class="n">stack_L5</span>

<span class="c1"># Station list used to stack</span>
<span class="n">stack_sta_list</span> <span class="o">=</span> <span class="o">/</span><span class="n">Users</span><span class="o">/</span><span class="n">xumj</span><span class="o">/</span><span class="n">Researches</span><span class="o">/</span><span class="n">NETibet</span><span class="o">/</span><span class="n">Ordos_Process</span><span class="o">/</span><span class="n">sta_L5</span><span class="o">.</span><span class="n">lst</span>

<span class="c1"># Path to 1D velocity model</span>
<span class="c1"># If it&#39;s empty, useing IASP91 model</span>
<span class="n">velmod</span> <span class="o">=</span>

<span class="p">[</span><span class="nb">bin</span><span class="p">]</span>
<span class="c1"># The shape of bins</span>
<span class="n">shape</span> <span class="o">=</span> <span class="n">rect</span>

<span class="c1"># period of S wave (to assuming the radius of fresnel zone)</span>
<span class="n">domperiod</span> <span class="o">=</span> <span class="mi">5</span>

<span class="c1"># Width of the profile in km</span>
<span class="n">width</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># Radius of bins in km</span>
<span class="c1"># If it&#39;s empty, radius would be assumed following fresnel zone</span>
<span class="n">bin_radius</span> <span class="o">=</span>

<span class="c1"># sliding interval of bins in km </span>
<span class="n">slid_val</span> <span class="o">=</span> <span class="mi">5</span>

<span class="p">[</span><span class="n">line</span><span class="p">]</span>
<span class="c1"># Coordinate of two end points for the profile</span>
<span class="n">profile_lat1</span> <span class="o">=</span> <span class="mf">40.82</span>
<span class="n">profile_lon1</span> <span class="o">=</span> <span class="mf">103.451</span>
<span class="n">profile_lat2</span> <span class="o">=</span> <span class="mf">36.33</span>
<span class="n">profile_lon2</span> <span class="o">=</span> <span class="mf">108.817</span>

<span class="p">[</span><span class="n">depth</span><span class="p">]</span>
<span class="c1"># Max depth you wanna convert to</span>
<span class="n">dep_end</span> <span class="o">=</span> <span class="mi">800</span>

<span class="c1"># depth interval in converting time to depth</span>
<span class="n">dep_val</span> <span class="o">=</span> <span class="mi">1</span>

<span class="p">[</span><span class="n">stack</span><span class="p">]</span>
<span class="c1"># Stack RFs from &lt;stack_start&gt; km to &lt;stack_end&gt; km with interval of &lt;stack_val&gt; km</span>
<span class="n">stack_start</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">stack_end</span> <span class="o">=</span> <span class="mi">150</span>
<span class="n">stack_val</span> <span class="o">=</span> <span class="mi">1</span></code></pre></div>
<h4 id="4-optional-a-lib-of-ps-ray-parameters">4. (Optional) A lib of Ps ray parameters.</h4>

<p>If you would stack PRFs in a great depth (e.g., D410 or D660), the ray parameters of P arrival cannot represent that of Ps phase. Therefore,
a library file of Ps ray parameters in different depths and epicentral distance is required in calculating Ps-P time difference.
This lib file has specific binary format. You can generate it by command of <code>gen_rayp_lib</code>:</p>
<div class="highlight"><pre class="chroma">usage: gen_rayp_lib [-h] -d DIS_STR -e DEP_STR [-l LAY_STR] [-o OUT_PATH]

Gen a ray parameter lib for Pds phases

optional arguments:
  -h, --help   show this help message and exit
  -d DIS_STR   Distance range as &#39;min_dis/max_dis/interval&#39;
  -e DEP_STR   Event depth range as &#39;min_dep/max_dep/interval&#39;
  -l LAY_STR   layers range as &#39;min_layer/man_layer&#39;
  -o OUT_PATH  Out path to Pds ray parameter lib</pre></div>
<h4 id="5-optional-a-3d-velocity-model">5. (Optional) A 3D velocity model</h4>

<p>To correct influence by velocity anomalies above the interface you wanna study, you can use a 3D velocity model to correct Ps-P time difference.
The model file should be <code>.npz</code> format (generated by <a href="https://docs.scipy.org/doc/numpy/reference/generated/numpy.savez.html?highlight=savez"><code>numpy.savez</code></a>) with 5 fields:</p>

<ul>
<li><code>dep</code>: Depth axis. 1D <code>numpy.array</code> with shape of <code>(len_dep,)</code></li>
<li><code>lat</code>: Latitude axis. 1D <code>numpy.array</code> with shape of <code>(len_lat,)</code></li>
<li><code>lon</code>: Longitude axis. 1D <code>numpy.array</code> with shape of <code>(len_lon,)</code></li>
<li><code>vp</code>: P wave velocity. 3D <code>numpy.array</code> with shape of <code>(len_dep, len_lat, len_lon)</code></li>
<li><code>vs</code>: S wave velocity. 3D <code>numpy.array</code> with shape of <code>(len_dep, len_lat, len_lon)</code></li>
</ul>

<h3 id="convert-time-to-depth">Convert time to depth</h3>

<p><code>rf2depth</code> command would convert PRFs from time axis to depth axis using above preparations:</p>
<div class="highlight"><pre class="chroma"><code class="language-Bash" data-lang="Bash">usage: rf2depth <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>-d VEL3DPATH<span class="o">]</span> cfg_file

Convert Ps RF to depth axis

positional arguments:
  cfg_file      Path to configure file

optional arguments:
  -h, --help    show this <span class="nb">help</span> message and <span class="nb">exit</span>
  -d VEL3DPATH  Path to 3d vel model in npz file</code></pre></div>
<p>The output struct would be saved as a <code>.mat</code> file, which can be read in <strong>MATLAB</strong>. Therefore, you can browse items and fields of this file using
<strong>MATLAB</strong> or <code>scipy.io.loadmat</code>. The number of items is equal to the number of stations in <em>Station list</em>. Each item has 9 fields:</p>

<ul>
<li><code>Station</code>: The station name.</li>
<li><code>stalat</code>: The Latitude of the station.</li>
<li><code>stalon</code>: The Longitude of the station.</li>
<li><code>bazi</code>: The back-azimuth of each event (1D array with shape of <code>(ev_num,)</code>).</li>
<li><code>rayp</code>: The Ray-parameter of each event (1D array with shape of <code>(ev_num,)</code>).</li>
<li><code>moveout_correct</code>: The amplitude for each PRF after time-depth conversion (2D array with shape of <code>(ev_num, layer_num)</code>).</li>
<li><code>Piercelat</code>: Latitudes of each event at each depth (2D array with shape of <code>(ev_num, layer_num)</code>).</li>
<li><code>Piercelon</code>: Longitudes of each event at each depth (2D array with shape of <code>(ev_num, layer_num)</code>).</li>
<li><code>StopIndex</code>: The last layer after time-depth conversion (2D array with shape of <code>(ev_num, layer_num)</code>).
&gt;Note: the <code>layer_num</code> was determined by field [depth] in parameter file.</li>
</ul>

<h3 id="ccp-stack-prfs-along-a-profile">CCP Stack PRFs along a profile</h3>

<p>The <code>ccp_profile</code> command provide functions to stack PRFs along a profile:</p>
<div class="highlight"><pre class="chroma"><code class="language-bash" data-lang="bash">usage: ccp_profile <span class="o">[</span>-h<span class="o">]</span> <span class="o">[</span>-l LINE_LOCA<span class="o">]</span> <span class="o">[</span>-s STALIST<span class="o">]</span> <span class="o">[</span>-o OUTPATH<span class="o">]</span> <span class="o">[</span>-t<span class="o">]</span> cfg_file

Stack PRFS along a profile

positional arguments:
  cfg_file      Path to CCP configure file

optional arguments:
  -h, --help    show this <span class="nb">help</span> message and <span class="nb">exit</span>
  -l LINE_LOCA  Location of the profile &lt;lat1&gt;/&lt;lon1&gt;/&lt;lat2&gt;/&lt;lon2&gt;
  -s STALIST    Path to station list
  -o OUTPATH    Path to output data
  -t            Output as text file</code></pre></div>
<h4 id="required-arguments">Required arguments</h4>

<ul>
<li><code>cfg_file</code>: the <em>parameter file</em> introduced above. Meanwhile, some options are required:

<ul>
<li><code>stack</code> section: Define the nodes of the profile</li>
<li><code>bin</code> section: The shape of bin.</li>
</ul></li>
</ul>

</div>
</div>

        </div>
      </div>
    </div>
    
  </div>

  <div class="sub-footer">
  <div class="container">
    <div class="row">
      <div class="col-12">
        <div class="sub-footer-inner">
          <ul>
            <li class="zerostatic"><a href="https://xumi1993.github.io/">xumi1993.github.io</a></li>
          </ul>
        </div>
      </div>
    </div>
  </div>
</div>

  

  
  

  
  <script type="text/javascript" src="/seispy/js/scripts.min.bf1e1f7ae8e03db5f012356e825843facdff51c0a559cb0d27fe2bbe1db405c2.js"></script>
  

  
  
  
    
  


</body>

</html>
